# coding=utf-8

# Python 3.6.3 win_amd64
# 依赖库：numpy、sklearn、scipy
# MNIST数据文件夹位于当前目录下

import data_adapter as da
import numpy as np
from sklearn import neighbors
from sklearn.decomposition import PCA
from sklearn.metrics import accuracy_score
import math
import time
import copy

# 主成分分析，对特征降维
def pca_feature(train_imgs, test_imgs, d):
    pca = PCA(n_components = d) # 保留 d 个特征
    pca_train_imgs = pca.fit_transform(train_imgs)
    pca_test_imgs = pca.transform(test_imgs)

    return pca_train_imgs, pca_test_imgs

if __name__ == '__main__':
    # 加载数据
    train_imgs = da.img_loader('MNIST/train-images.idx3-ubyte')
    train_labels = da.label_loader('MNIST/train-labels.idx1-ubyte')
    test_imgs = da.img_loader('MNIST/t10k-images.idx3-ubyte')
    test_labels = da.label_loader('MNIST/t10k-labels.idx1-ubyte')

    # 进行主成分分析
    for d in range(10, 171, 10):
        pca_train_imgs, pca_test_imgs = pca_feature(train_imgs, test_imgs, d)

        # KNN
        for k in [1] + (list(range(5,61,5))):
            knc = neighbors.KNeighborsClassifier(k)
            knc.fit(pca_train_imgs, train_labels)
            prediction = knc.predict(pca_test_imgs)
            accuracy = accuracy_score(test_labels, prediction)
            print(d, k, accuracy)
    
    
# 运行结果：
# Load MNIST/train-images.idx3-ubyte succeeded...
# Load MNIST/train-labels.idx1-ubyte succeeded...
# Load MNIST/t10k-images.idx3-ubyte succeeded...
# Load MNIST/t10k-labels.idx1-ubyte succeeded...
# 10 1 0.9137
# 10 5 0.9276
# 10 10 0.929
# 10 15 0.9291
# 10 20 0.9282
# 10 25 0.9269
# 10 30 0.9257
# 10 35 0.9239
# 10 40 0.9225
# 10 45 0.9215
# 10 50 0.9219
# 10 55 0.921
# 10 60 0.9208
# 20 1 0.9637
# 20 5 0.9691
# 20 10 0.9697
# 20 15 0.968
# 20 20 0.9659
# 20 25 0.9634
# 20 30 0.9626
# 20 35 0.9618
# 20 40 0.9595
# 20 45 0.9585
# 20 50 0.9582
# 20 55 0.9577
# 20 60 0.9572
# 30 1 0.972
# 30 5 0.9752
# 30 10 0.9746
# 30 15 0.9724
# 30 20 0.9723
# 30 25 0.9699
# 30 30 0.9686
# 30 35 0.9669
# 30 40 0.9652
# 30 45 0.9639
# 30 50 0.9631
# 30 55 0.9616
# 30 60 0.9613
# 40 1 0.9737
# 40 5 0.9747
# 40 10 0.9741
# 40 15 0.9712
# 40 20 0.9712
# 40 25 0.9697
# 40 30 0.9681
# 40 35 0.9666
# 40 40 0.9653
# 40 45 0.9635
# 40 50 0.9632
# 40 55 0.9616
# 40 60 0.9608
# 50 1 0.9735
# 50 5 0.9747
# 50 10 0.9741
# 50 15 0.9721
# 50 20 0.9713
# 50 25 0.9689
# 50 30 0.9687
# 50 35 0.9666
# 50 40 0.9637
# 50 45 0.964
# 50 50 0.9632
# 50 55 0.9619
# 50 60 0.9604
# 60 1 0.9729
# 60 5 0.9753
# 60 10 0.9738
# 60 15 0.9705
# 60 20 0.9704
# 60 25 0.9682
# 60 30 0.967
# 60 35 0.9657
# 60 40 0.9644
# 60 45 0.9632
# 60 50 0.9616
# 60 55 0.9604
# 60 60 0.9605
# 70 1 0.9727
# 70 5 0.9746
# 70 10 0.973
# 70 15 0.9708
# 70 20 0.9685
# 70 25 0.9676
# 70 30 0.9659
# 70 35 0.9644
# 70 40 0.9638
# 70 45 0.9624
# 70 50 0.9618
# 70 55 0.9609
# 70 60 0.9588
# 80 1 0.9729
# 80 5 0.9737
# 80 10 0.9724
# 80 15 0.9692
# 80 20 0.9684
# 80 25 0.9667
# 80 30 0.9651
# 80 35 0.9634
# 80 40 0.9626
# 80 45 0.9614
# 80 50 0.9604
# 80 55 0.959
# 80 60 0.9575
# 90 1 0.9726
# 90 5 0.9726
# 90 10 0.9714
# 90 15 0.9686
# 90 20 0.9674
# 90 25 0.9645
# 90 30 0.9652
# 90 35 0.9629
# 90 40 0.9611
# 90 45 0.9595
# 90 50 0.9583
# 90 55 0.9581
# 90 60 0.9572
# 100 1 0.9716
# 100 5 0.972
# 100 10 0.9705
# 100 15 0.9683
# 100 20 0.9661
# 100 25 0.9649
# 100 30 0.9631
# 100 35 0.9615
# 100 40 0.9604
# 100 45 0.9595
# 100 50 0.9579
# 100 55 0.9569
# 100 60 0.9565
# 110 1 0.9707
# 110 5 0.9728
# 110 10 0.9701
# 110 15 0.9674
# 110 20 0.9658
# 110 25 0.9638
# 110 30 0.963
# 110 35 0.9608
# 110 40 0.9604
# 110 45 0.958
# 110 50 0.9574
# 110 55 0.9566
# 110 60 0.9559
# 120 1 0.9705
# 120 5 0.9723
# 120 10 0.9702
# 120 15 0.9679
# 120 20 0.9647
# 120 25 0.9639
# 120 30 0.9629
# 120 35 0.9605
# 120 40 0.9595
# 120 45 0.9583
# 120 50 0.958
# 120 55 0.9563
# 120 60 0.9557
# 130 1 0.9703
# 130 5 0.9719
# 130 10 0.9693
# 130 15 0.9663
# 130 20 0.9645
# 130 25 0.9635
# 130 30 0.9617
# 130 35 0.9605
# 130 40 0.9597
# 130 45 0.9578
# 130 50 0.9572
# 130 55 0.956
# 130 60 0.9554
# 140 1 0.9699
# 140 5 0.9719
# 140 10 0.9686
# 140 15 0.9666
# 140 20 0.9644
# 140 25 0.9635
# 140 30 0.9613
# 140 35 0.9603
# 140 40 0.9588
# 140 45 0.9576
# 140 50 0.9566
# 140 55 0.9555
# 140 60 0.9551
# 150 1 0.9695
# 150 5 0.9713
# 150 10 0.9684
# 150 15 0.966
# 150 20 0.9641
# 150 25 0.9628
# 150 30 0.9617
# 150 35 0.9602
# 150 40 0.9585
# 150 45 0.9571
# 150 50 0.9567
# 150 55 0.9558
# 150 60 0.9547
# 160 1 0.9699
# 160 5 0.9712
# 160 10 0.969
# 160 15 0.9664
# 160 20 0.9638
# 160 25 0.9623
# 160 30 0.9615
# 160 35 0.9594
# 160 40 0.9585
# 160 45 0.9568
# 160 50 0.9562
# 160 55 0.9552
# 160 60 0.9541
# 170 1 0.9694
# 170 5 0.9705
# 170 10 0.9685
# 170 15 0.9657
# 170 20 0.9635
# 170 25 0.9625
# 170 30 0.9609
# 170 35 0.9597
# 170 40 0.9581
# 170 45 0.9565
# 170 50 0.956
# 170 55 0.9548
# 170 60 0.9538